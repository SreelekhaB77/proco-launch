steps:
- id: "Fetching source" 
  name: gcr.io/cloud-builders/gcloud
  args:
    - source
    - repos
    - clone 
    - moderntrade-common-util
- id: "Building Artifacts"
  name: gcr.io/cloud-builders/mvn
  entrypoint: bash
  args:
    - -c
    - | 
      mvn -f /workspace/moderntrade-common-util/pom.xml clean install
      mvn clean install
- id: "Deploying into VM"
  name: gcr.io/cloud-builders/gcloud
  args:
    - compute
    - scp
    - target/$_ARTIFACT_NAME
    - $_VM_NAME:/home/appuser
    - --zone=$_VM_ZONE
    - --impersonate-service-account=$_SERVICE_ACCOUNT_EMAIL
- id: "Restarting the service in VM"
  name: gcr.io/cloud-builders/gcloud
  entrypoint: bash
  args:
    - -c
    - |
      gcloud compute ssh $_VM_NAME --zone=$_VM_ZONE --command="kill -9 `ps -ef | grep 'java -jar procolaunch.war' | head -1 | awk '{print $2}'`;nohup java -jar procolaunch.war > procolaunch.log &"